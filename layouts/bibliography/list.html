{{ define "sidebar" }}{{ end }}
{{ define "main" }}

<header class="container-fluid mb-3">
  <div class="row align-items-end g-3">
    <div class="col-lg">
      <h1 class="h3 m-0">{{ or .Params.heading .Title }}</h1>
    </div>
    <div class="col-lg-auto">
      <form class="row row-cols-auto g-2 align-items-center">
        <div class="col">
          <label class="form-label mb-0 small" for="itemTypeFilter">Type</label>
          <select id="itemTypeFilter" class="form-select form-select-sm">
            <option value="all">All</option>
            {{ range $key, $value := .Site.Taxonomies.item_type }}
              <option value="{{ $key }}">{{ $key | title }}</option>
            {{ end }}
          </select>
        </div>
        <div class="col">
          <label class="form-label mb-0 small" for="dateExpr">Date</label>
          <input id="dateExpr"
                 type="text"
                 class="form-control form-control-sm"
                 placeholder="1980, >=1980-01-01, 1970 to 1980"
                 data-bs-toggle="tooltip"
                 data-bs-trigger="focus"
                 data-bs-animation="true"
                 data-bs-html="true"
                 title="<strong>Formats</strong><br>1980<br>1980-05<br>1980-05-12<br>&gt;=1980  &lt;1990  =1980-05<br>1970 to 1980" />
        </div>
      </form>
    </div>
  </div>
</header>

<div class="container-fluid">
  {{ .Content }}
  <ul class="list-unstyled" id="bibliographyList">
    {{- $previewWordLimit := 24 -}}
    {{- $pages := .RegularPages -}}
    {{- $pages = sort $pages "Date" "desc" -}}
    {{- $pages = sort $pages "Title" "asc" -}}
    {{ range $pages }}
      {{- $d := .Date -}}
      {{- with .Params.date }}
        {{- $iso := trim . " " -}}
        {{- if and (ne $iso "") (findRE `^\d{4}-\d{2}-\d{2}$` $iso) }}
          {{- $d = time $iso -}}
        {{- end -}}
      {{- end -}}
      {{- $fullDate := $d.Format "2006-01-02" -}}
      {{- $year := $d.Format "2006" -}}
      {{- if eq $year "0001" }}{{- $year = "undated" -}}{{ end -}}

      {{- $types := "" -}}
      {{- with .Params.item_type }}
        {{- if reflect.IsSlice . }}
          {{- $types = delimit (apply . "lower" ".") "," -}}
        {{- else }}
          {{- $types = lower . -}}
        {{- end -}}
      {{- end -}}

      <li class="py-3 border-bottom pub-item"
          data-type="{{ $types }}"
          data-year="{{ $year }}"
          data-date="{{ if ne $fullDate "0001-01-01" }}{{ $fullDate }}{{ end }}">
        <div class="fw-semibold">
          {{- $rawTitle := or .Params.title .Title -}}
          {{- $rendered := replaceRE "^<p>(.*)</p>$" "$1" $rawTitle | htmlEscape -}}
          <a href="{{ .RelPermalink }}" class="text-decoration-none">{{ $rendered | safeHTML }}</a>
        </div>

        {{- $authors := .Params.authors -}}
        {{- $editors := .Params.editors -}}
        {{- $isPatent := eq .Params.item_type "patent" -}}
        {{- if or $authors $editors }}
          <div class="small text-muted">
            {{- if $authors }}
              {{- if reflect.IsSlice $authors }}
                {{- if $isPatent }}Inventors: {{ end }}{{ delimit $authors "; " "; and " }}
              {{- else }}
                {{- if $isPatent }}Inventor: {{ end }}{{ $authors }}
              {{- end }}
            {{- else }}
              Edited by: {{ if reflect.IsSlice $editors }}{{ delimit $editors "; " "; and " }}{{ else }}{{ $editors }}{{ end }}
            {{- end }}
          </div>
        {{- end }}

        {{- if ne $fullDate "0001-01-01" }}
          <div class="small">
            <time datetime="{{ $fullDate }}">{{ .Params.readabledate }}</time>
          </div>
        {{- end }}

        {{ with .Params.abstract }}
          {{- $plain := . | htmlEscape | replaceRE `\s+` " " -}}
          {{- $previewing := gt (countwords $plain) $previewWordLimit -}}
          {{- if $previewing }}
            {{- $previewWords := split $plain " " | first $previewWordLimit -}}
            <div class="mt-2 small">{{ delimit $previewWords " " | safeHTML }}â€¦</div>
          {{- else }}
            <div class="mt-2 small">{{ replace (. | htmlEscape) "\n" "<br>" | safeHTML }}</div>
          {{- end }}
        {{ end }}
      </li>
    {{ end }}
  </ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Bootstrap tooltip init
  if (window.bootstrap) {
    Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      .forEach(el => new bootstrap.Tooltip(el));
  }

  const dateInput = document.getElementById('dateExpr');
  const tip = bootstrap.Tooltip.getInstance(dateInput);

  function dismissTooltip() {
    if (!dateInput.dataset.tipDismissed && tip) {
      tip.hide();
      // Dispose after fade so it never reappears
      setTimeout(() => tip.dispose(), 200);
      dateInput.dataset.tipDismissed = '1';
    }
  }

  // Hide on first input, paste, or keypress
  ['input','paste','keydown'].forEach(evt =>
    dateInput.addEventListener(evt, dismissTooltip, { once:false })
  );

  dateInput.addEventListener('blur', dismissTooltip);

  const typeSel  = document.getElementById('itemTypeFilter');
  const dateExpr = document.getElementById('dateExpr');
  const items    = Array.from(document.querySelectorAll('#bibliographyList > li'));

  function parseDate(s, isEnd=false) {
    if (!s) return null;
    const m = s.match(/^(\d{4})(?:-(\d{2})(?:-(\d{2}))?)?$/);
    if (!m) return null;
    let [ , Y, M, D ] = m;
    M = M || (isEnd ? '12' : '01');
    D = D || (isEnd ? '31' : '01');
    if (+M > 12) M = '12';
    if (+D > 31) D = '31';
    return new Date(`${Y}-${M}-${D}T00:00:00Z`);
  }

  function buildPredicate(expr) {
    expr = (expr || '').trim();
    if (!expr) return () => true;

    let m = expr.match(/^(\d{4}(?:-\d{2}(?:-\d{2})?)?)\s+to\s+(\d{4}(?:-\d{2}(?:-\d{2})?)?)$/i);
    if (m) {
      const start = parseDate(m[1], false);
      const end   = parseDate(m[2], true);
      if (!start || !end) return () => true;
      return d => d && d >= start && d <= end;
    }

    m = expr.match(/^([<>]=?|=)\s*(\d{4}(?:-\d{2}(?:-\d{2})?)?)$/);
    if (m) {
      const op = m[1];
      const dtStart = parseDate(m[2], false);
      const dtEnd = parseDate(m[2], true);
      if (!dtStart || !dtEnd) return () => true;
      return d => {
        if (!d) return false;
        switch (op) {
          case '=':  return d >= dtStart && d <= dtEnd;
          case '>':  return d > dtEnd;
          case '>=': return d >= dtStart;
          case '<':  return d < dtStart;
          case '<=': return d <= dtEnd;
          default: return true;
        }
      };
    }

    m = expr.match(/^(\d{4}(?:-\d{2}(?:-\d{2})?)?)$/);
    if (m) {
      const s = parseDate(m[1], false);
      const e = parseDate(m[1], true);
      if (!s || !e) return () => true;
      return d => d && d >= s && d <= e;
    }

    return () => true;
  }

  function showHide() {
    const typeVal = (typeSel.value || 'all').toLowerCase();
    const pred = buildPredicate(dateExpr.value);
    items.forEach(li => {
      const types = (li.dataset.type || '')
        .split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
      const dateStr = li.dataset.date;
      const dateObj = dateStr ? new Date(dateStr + 'T00:00:00Z') : null;
      const typeOK = (typeVal === 'all') || types.includes(typeVal);
      const dateOK = pred(dateObj);
      li.style.display = (typeOK && dateOK) ? '' : 'none';
    });
  }

  const params = new URLSearchParams(window.location.search);
  const qType = (params.get('item_type') || '').toLowerCase();
  if (qType && typeSel.querySelector(`option[value="${qType}"]`)) typeSel.value = qType;
  const qDate = params.get('date');
  if (qDate) dateExpr.value = qDate;

  typeSel.addEventListener('change', showHide);
  dateExpr.addEventListener('input', showHide);
  showHide();
});
</script>

{{ end }}