{{ define "main" }}
<article class="bibliography-entry">
  <h1>{{ .Title }}</h1>

{{- $authors := .Params.authors -}}
{{- $editors := .Params.editors -}}
{{- $isPatent := eq .Params.item_type "patent" -}}
{{- if or $authors $editors -}} {{- /* no empty <p> if neither */ -}}
  <p>
  {{- if $authors -}}
    {{- if reflect.IsSlice $authors -}}
      {{- if $isPatent }}
        <strong>Inventors:</strong> 
      {{ end }}
      {{ delimit $authors "; " "; and " }}
    {{- else -}}
      {{- if $isPatent }}
        <strong>Inventor:</strong> 
      {{ end }}
        {{ $authors }}
    {{- end -}}
  {{- else -}}
    <strong>Edited by:</strong> 
    {{ if reflect.IsSlice $editors }}
       {{ delimit $editors "; " "; and " }}
    {{- else }}
        {{ $editors }}
    {{- end -}}
  {{- end -}}
  <br></p>
{{- end -}}

<p>
  {{- $d := .Date -}}
      {{- $fmtDate := .Params.readabledate -}}
  {{- with .Params.date -}}
    {{- $isoDate := trim . " " -}}
    {{- if and (ne $isoDate "") (findRE `^\d{4}-\d{2}-\d{2}` $isoDate) -}}
      {{- $d = time $isoDate -}}
    {{- end -}}
  {{- end }}
  {{- $d = $d.Format "2006-01-02" -}}
  {{- /* Don't display bogus date */ -}}
  {{- if (ne $d "0001-01-01") }}
    <time datetime="{{ $d }}">{{ $fmtDate }}</time>
  {{ end -}}
</p>
<p>
    <strong>View document:</strong>  {{ with .Params.url_source }}
      <a href="{{ . | safeURL }}" target="_blank" rel="noopener noreferrer">{{ . }}</a>
    {{ else }}
      No URL to the document is available.
    {{ end }}
    <br>

    <!-- Citation -->
    {{/* Build Zotero API params (group id + item key + style) */}}
      {{ $gid := "2914042" }}

      {{ $key := .File.TranslationBaseName }}

      {{ $style := or site.Params.zotero.style "apa" }}

      {{ if and $gid $key }}
        <br>
        <a href="#" id="citeBtn"
           data-gid="{{ $gid }}"
           data-key="{{ $key }}"
           data-style="{{ $style }}"
        >Citation</a>
      {{ end }}
</p>
<p>
    <strong>Abstract</strong>
    <br>
    {{ with .Params.abstract }}
      {{ . | htmlEscape | markdownify }}
    {{ else }}
      No abstract available.
    {{ end }}

</p>

  <p>
    {{ if eq .Params.item_type "book" }}
        {{ with .Params.publisher }}
            <p><strong>Publisher:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.place }}
            <p>{{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "paper-conference" }}
        {{ with .Params.proceedings_title }}
            <p><strong>Proceedings:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.publisher }}
            <p><strong>Journal:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "article" }}
        {{ with .Params.publisher }}
            <p><strong>Publisher:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "article-journal" }}
        {{ with .Params.publication_title }}
            <p><strong>Journal:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.volume }}
            <p><strong>Volume:</strong> {{ . }}
        {{ end }}
        {{ with .Params.issue }}
            <strong>Issue:</strong> {{ . }}
        {{ end }}
        {{ with .Params.pages }}
            <strong>Pages:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "report" }}
        {{ with .Params.publication_title }}
            <p><strong>Publisher:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.reportType }}
            <p><strong>Report Type:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.reportNumber }}
            <p><strong>Report Number:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "thesis" }}
        {{ with .Params.university }}
            <p><strong>University:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.place }}
            <p><strong>Place:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "patent" }}
        {{ with .Params.assignee }}
            <p><strong>Assignee:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.application_number }}
            <p><strong>Application Number:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.filing_date }}
            <p><strong>Filing Date:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.issuing_authority }}
            <p><strong>Issuing Authority:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.patent_number }}
            <p><strong>Patent Number:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "post-weblog" }}
        {{ with .Params.blog_title }}
            <p><strong>Blog Title:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "article-magazine" }}
        {{ with .Params.publication_title }}
            <p><strong>Magazine:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.volume }}
            <p><strong>Volume:</strong> {{ . }}
        {{ end }}
        {{ with .Params.issue }}
            <strong>Issue:</strong> {{ . }}
        {{ end }}
        {{ with .Params.pages }}
            <strong>Pages:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "motion_picture" }}
        {{ with .Params.studio }}
            <p><strong>Studio:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.video_recording_format }}
            <p><strong>Video Recording Format:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.series_title }}
            <p><strong>Series Title:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.volume }}
            <p><strong>Volume:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.number_of_volumes }}
            <p><strong>Number of Volumes:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "chapter" }}
        {{ with .Params.book_title }}
            <p><strong>Book Title:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.publisher }}
            <p><strong>Publisher:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.series }}
            <p><strong>Series:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.series_number }}
            <p><strong>Series Number:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.pages }}
            <p><strong>Pages:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "personal_communication" }}
        {{ with .Params.communication_type }}
            <p><strong>Item Type:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "webpage" }}
        {{ with .Params.website_title }}
            <p><strong>Website Title:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.website_type }}
            <p><strong>Website Type:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
    {{ if eq .Params.item_type "entry-encyclopedia" }}
        {{ with .Params.encyclopedia_title }}
            <p><strong>Encyclopedia Title:</strong> {{ . }}</p>
        {{ end }}
    {{ end }}
  </p>
  <p>
    {{- if .Params.zotero_url }}
        <a href="{{ .Params.zotero_url | safeURL }}" target="_blank" rel="noopener noreferrer">View on Zotero</a>
    {{- end -}}
  </p>
    
  <div class="summary">
    {{ .Content }}
  </div>
</article>
  <!-- Citation modal -->
<div id="citationModal" class="citation-modal" hidden>
  <div class="citation-dialog">
    <div class="citation-header">
      <strong>Citation</strong>
      <button type="button" class="citation-close" aria-label="Close">×</button>
    </div>

    <!-- Tabs -->
    <div class="citation-tabs" role="tablist" aria-label="Citation views">
      <button type="button" class="tab-btn is-active" data-tab="formatted" role="tab" aria-selected="true" aria-controls="tab-formatted">Formatted</button>
      <button type="button" class="tab-btn" data-tab="raw" role="tab" aria-selected="false" aria-controls="tab-raw">HTML</button>
    </div>

    <div class="citation-body">
      <!-- Formatted view -->
      <div id="tab-formatted" class="tab-panel is-active" role="tabpanel" aria-labelledby="tabbtn-formatted">
        <div id="citationContent">Loading…</div>
      </div>

      <!-- Raw HTML view -->
      <div id="tab-raw" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-raw">
        <pre class="codebox"><code id="citationRaw" class="language-html"></code></pre>
      </div>
    </div>

    <div class="citation-actions">
      <button type="button" id="copyCitation">Copy Text</button>
      <button type="button" id="copyCitationHtml">Copy HTML</button>
      <button type="button" class="citation-close">Close</button>
    </div>
  </div>
  <div class="citation-backdrop"></div>
</div>


  <style>
  .citation-modal[hidden] { display: none; }
  .citation-modal { position: fixed; inset: 0; z-index: 1050; }
  .citation-dialog {
    position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
    max-width: 720px; width: calc(100% - 2rem);
    background: #fff; border-radius: 6px; box-shadow: 0 10px 30px rgba(0,0,0,.2);
    overflow: hidden;
  }
  .citation-header { display:flex; justify-content:space-between; align-items:center; padding:.75rem 1rem; border-bottom:1px solid #eee; }
  .citation-close { background:none; border:0; font-size:1.25rem; line-height:1; cursor:pointer; }
  .citation-tabs { display:flex; gap:.25rem; padding:.5rem 1rem; border-bottom:1px solid #eee; }
  .tab-btn {
    border: 1px solid #ddd; background:#f8f9fa; border-radius:4px; padding:.35rem .6rem; cursor:pointer;
  }
  .tab-btn.is-active { background:#fff; border-color:#bbb; }
  .citation-body { padding:1rem; max-height:50vh; overflow:auto; }
  #citationContent { font-size:1rem; line-height:1.4; }
  .codebox {
    background:#f6f8fa; border:1px solid #e1e4e8; border-radius:6px;
    padding:.75rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size:.9rem; line-height:1.4; white-space:pre-wrap; word-break:break-word;
  }
  .tab-panel { display:none; }
  .tab-panel.is-active { display:block; }
  .citation-actions { display:flex; gap:.5rem; justify-content:flex-end; padding:.75rem 1rem; border-top:1px solid #eee; }
</style>

<script src="{{ "js/vendor/prettier/standalone.js" | relURL }}" defer></script>
<script src="{{ "js/vendor/prettier/plugins/html.js" | relURL }}" defer></script>

<script>
(function () {
  const modal = document.getElementById('citationModal');
  const contentBox = document.getElementById('citationContent');
  const rawBox = document.getElementById('citationRaw');

  function openModal() { modal.hidden = false; }
  function closeModal() { modal.hidden = true; }

  function setActiveTab(name) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      const isActive = btn.dataset.tab === name;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
    document.querySelectorAll('.tab-panel').forEach(panel => {
      const isActive = panel.id === ('tab-' + name);
      panel.classList.toggle('is-active', isActive);
    });
  }

  function copyTextToClipboard(text, button) {
    const done = () => {
      if (button) {
        const original = button.textContent;
        button.textContent = 'Copied';
        setTimeout(() => (button.textContent = original), 1200);
      }
    };
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(done).catch(done);
    } else {
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta);
      ta.select(); try { document.execCommand('copy'); } catch(e) {}
      document.body.removeChild(ta); done();
    }
  }

  document.addEventListener('click', function (e) {
    // Open + fetch
    if (e.target.matches('#citeBtn')) {
      e.preventDefault();
      const btn = e.target;
      const gid = btn.dataset.gid;
      const key = btn.dataset.key;
      const style = btn.dataset.style || 'apa';
      // Use Zotero API; format=bib returns HTML bibliography item(s)
      const url = `https://api.zotero.org/groups/${encodeURIComponent(gid)}/items/${encodeURIComponent(key)}?format=bib&style=${encodeURIComponent(style)}&linkwrap=1`;

      contentBox.textContent = 'Loading…';
      rawBox.textContent = '';
      setActiveTab('formatted');
      openModal();

      fetch(url, { headers: { 'Accept': 'text/html' }})
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.text();
        })
        .then(html => {
          contentBox.innerHTML = html;
          try {
            const formatted = window.prettier.format(html, { parser: "html", plugins: window.prettierPlugins, tabWidth: 2 });
            // prettier.format may return a string or a Promise depending on plugin loading; normalize to a Promise
            return Promise.resolve(formatted).then(pretty => {
              rawBox.textContent = pretty;
              return html;
            });
          } catch (err) {
            // synchronous error formatting
            rawBox.textContent = String(err);
            return html;
          }
        })
        .catch(err => {
          const msg = `Failed to load citation (${err})`;
          contentBox.textContent = msg;
          rawBox.textContent = msg;
        });
    }

    // Close
    if (e.target.matches('.citation-close')) {
      e.preventDefault();
      closeModal();
    }

    // Copy buttons
    if (e.target.matches('#copyCitation')) {
      e.preventDefault();
      copyTextToClipboard(contentBox.innerText.trim(), e.target);
    }
    if (e.target.matches('#copyCitationHtml')) {
      e.preventDefault();
      copyTextToClipboard(rawBox.textContent.trim(), e.target);
    }

    // Tabs
    if (e.target.matches('.tab-btn')) {
      e.preventDefault();
      setActiveTab(e.target.dataset.tab);
    }
  });

  // Close when clicking backdrop or pressing Escape
  modal.addEventListener('click', function (e) {
    if (e.target.classList.contains('citation-backdrop')) closeModal();
  });
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') closeModal();
  });
})();
</script>

{{ end }}
