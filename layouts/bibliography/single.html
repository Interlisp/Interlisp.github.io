{{- define "main" -}}
<article class="bibliography-entry" id="{{ .File.BaseFileName }}">
  <h1>{{ .Title }}</h1>

{{- $authors := .Params.authors -}}
{{- $editors := .Params.editors -}}
{{- $isPatent := eq .Params.item_type "patent" -}}
{{- if or $authors $editors -}} {{- /* no empty <p> if neither */ -}}
  <p>
  {{- if $authors -}}
    {{- if reflect.IsSlice $authors -}}
      {{- if $isPatent }}
        <strong>Inventors:</strong> 
      {{ end }}
      {{ delimit $authors "; " "; and " }}
    {{- else -}}
      {{- if $isPatent }}
        <strong>Inventor:</strong> 
      {{ end }}
        {{ $authors }}
    {{- end -}}
  {{- else -}}
    <strong>Edited by:</strong> 
    {{ if reflect.IsSlice $editors }}
       {{ delimit $editors "; " "; and " }}
    {{- else }}
        {{ $editors }}
    {{- end -}}
  {{- end -}}
  </p>
{{- end -}}
<p>
  {{- $dateTime := .Date -}}
  {{- with .Params.date -}}
    {{- $isoDate := trim . " " -}}
    {{- if and (ne $isoDate "") (findRE `^\d{4}-\d{2}-\d{2}` $isoDate) -}}
      {{- $dateTime = time $isoDate -}}
    {{- end -}}
  {{- end -}}
  {{- $dateISO := $dateTime.Format "2006-01-02" -}}
  {{- $dateLabel := or .Params.readabledate $dateISO -}}
  {{- /* Don't display bogus date */ -}}
  {{- if ne $dateISO "0001-01-01" -}}
    <time datetime="{{ $dateISO }}">{{ $dateLabel }}</time>
  {{- end -}}
</p>
<p>
    <strong>Abstract</strong>
    <br>
    {{- with .Params.abstract -}}
      {{- . | htmlEscape | markdownify -}}
    {{- else -}}
      No abstract available.
    {{- end -}}
</p>
    <div class="bibliography-meta">
    {{- if eq .Params.item_type "book" -}}
        {{ with .Params.publisher }}
            <p><strong>Publisher:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.place }}
            <p>{{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "paper-conference" -}}
        {{ with .Params.proceedings_title }}
            <p><strong>Proceedings:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.publisher }}
            <p><strong>Journal:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "article" -}}
        {{ with .Params.publisher }}
            <p><strong>Publisher:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if or (eq .Params.item_type "article-journal") (eq .Params.item_type "article-magazine") -}}
      <p>
      {{ if eq .Params.item_type "article-journal" -}}
        <strong>Journal:</strong>
      {{- else -}}
        <strong>Magazine:</strong>
      {{- end }}
      {{- with .Params.publication_title }} {{ . }}{{ end -}}
      </p>
      {{- if or .Params.volume .Params.issue .Params.pages }}
      <p>
      {{ with .Params.volume }}
        <strong>Volume:</strong> {{ . }}
      {{ end }}
      {{ with .Params.issue }}
        <strong>Issue:</strong> {{ . }}
      {{ end }}
      {{ with .Params.pages }}
        <strong>Pages:</strong> {{ . }}
      {{ end }}
      </p>
      {{- end }}
    {{- end -}}
    {{- if eq .Params.item_type "report" -}}
        {{ with .Params.publisher }}
            <p><strong>Publisher:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.reportType }}
            <p><strong>Report Type:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.reportNumber }}
            <p><strong>Report Number:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "thesis" -}}
        {{ with .Params.university }}
            <p><strong>University:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.place }}
            <p><strong>Place:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "patent" -}}
        {{ with .Params.assignee }}
            <p><strong>Assignee:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.application_number }}
            <p><strong>Application Number:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.filing_date }}
            <p><strong>Filing Date:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.issuing_authority }}
            <p><strong>Issuing Authority:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.patent_number }}
            <p><strong>Patent Number:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "post-weblog" -}}
        {{ with .Params.blog_title }}
            <p><strong>Blog Title:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "motion_picture" -}}
        {{ with .Params.studio }}
            <p><strong>Studio:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.video_recording_format }}
            <p><strong>Video Recording Format:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.series_title }}
            <p><strong>Series Title:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.volume }}
            <p><strong>Volume:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.number_of_volumes }}
            <p><strong>Number of Volumes:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "chapter" -}}
        {{ with .Params.book_title }}
            <p><strong>Book Title:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.publisher }}
            <p><strong>Publisher:</strong> {{ . }}</p>
        {{ end }}
      {{- if or .Params.series .Params.series_number .Params.pages -}}
      <p>
      {{ with .Params.series }}
        <strong>Series:</strong> {{ . }}
      {{ end }}
      {{ with .Params.series_number }}
        <strong>Series Number:</strong> {{ . }}
      {{ end }}
      {{ with .Params.pages }}
        <strong>Pages:</strong> {{ . }}
      {{ end }}
      </p>
      {{- end -}}
    {{- end -}}
    {{- if eq .Params.item_type "personal_communication" -}}
        {{ with .Params.communication_type }}
            <p><strong>Item Type:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "webpage" }}
        {{ with .Params.website_title -}}
            <p><strong>Website Title:</strong> {{ . }}</p>
        {{ end }}
        {{ with .Params.website_type }}
            <p><strong>Website Type:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
    {{- if eq .Params.item_type "entry-encyclopedia" }}
        {{ with .Params.encyclopedia_title }}
            <p><strong>Encyclopedia Title:</strong> {{ . }}</p>
        {{ end }}
    {{- end -}}
  </div>
  <p>
    {{- if .Params.url_source -}}
      <a class="btn btn-primary btn-sm"
         href="{{ .Params.url_source | safeURL }}"
         target="_blank" rel="noopener noreferrer">View</a>
    {{ else }}
        No URL to the document is available.
    {{ end }}
  </p>
  <p>
  {{- if .Params.zotero_url -}}
    <a class="btn btn-primary btn-sm"
       href="{{ .Params.zotero_url | safeURL }}"
       target="_blank" rel="noopener noreferrer">Zotero Record</a>
  {{- end -}}
  {{- /* Build Zotero API params (group id + item key + style) */ -}}
  {{- $gid := site.Params.zotero_group_id -}}
  {{- $key := .File.TranslationBaseName -}}
  {{- $style := or site.Params.zotero.style "apa" -}}
  {{ if and $gid $key }}
    <button type="button" id="citeBtn"
            class="btn btn-primary btn-sm"
            data-gid="{{ $gid }}"
            data-key="{{ $key }}"
            data-style="{{ $style }}">
      Citation
    </button>
      {{ end }}
  </p>
  <div class="summary">
    {{ .Content }}
  </div>
</article>
  <!-- Citation modal -->
<div id="citationModal" class="citation-modal" hidden role="dialog" aria-modal="true" aria-labelledby="citationModalTitle">
  <div class="citation-dialog">
    <div class="citation-header">
      <strong id="citationModalTitle">Citation</strong>
      <button type="button" class="citation-dismiss" aria-label="Close">×</button>
    </div>
    <div class="citation-tabs" role="tablist" aria-label="Citation views">
      <button type="button" class="tab-btn is-active" id="tabbtn-formatted" data-tab="formatted" role="tab" aria-selected="true" aria-controls="tab-formatted">Formatted</button>
      <button type="button" class="tab-btn" id="tabbtn-raw" data-tab="raw" role="tab" aria-selected="false" aria-controls="tab-raw">HTML</button>
      <button type="button" class="tab-btn" id="tabbtn-json" data-tab="json" role="tab" aria-selected="false" aria-controls="tab-json">JSON</button>
    </div>
    <div class="citation-body">
      <div id="tab-formatted" class="tab-panel is-active" role="tabpanel" tabindex="0" aria-labelledby="tabbtn-formatted">
        <div id="citationContent" role="status" aria-live="polite" aria-atomic="true">Loading…</div>
      </div>
      <div id="tab-raw" class="tab-panel" role="tabpanel" tabindex="0" aria-labelledby="tabbtn-raw">
        <pre class="codebox"><code id="citationRaw" class="language-html"></code></pre>
      </div>
      <div id="tab-json" class="tab-panel" role="tabpanel" tabindex="0" aria-labelledby="tabbtn-json">
        <pre class="codebox"><code id="citationJson" class="language-json"></code></pre>
      </div>
    </div>
    <div class="citation-actions">
      <button type="button" id="copyCitation">Copy</button>
      <button type="button" class="citation-close">Close</button>
    </div>
  </div>
  <div class="citation-backdrop"></div>
</div>

  <style>
  .citation-modal[hidden] { display: none; }
  .citation-modal { position: fixed; inset: 0; z-index: 1050; pointer-events: auto; }
  .citation-dialog {
    position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
    max-width: 720px; width: calc(100% - 2rem);
    background: #fff; border-radius: 6px; box-shadow: 0 10px 30px rgba(0,0,0,.2);
    overflow: hidden;
    z-index: 1;
  }
  .citation-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.4);
    pointer-events: auto;
    z-index: 0;
  }
  .citation-header { display:flex; justify-content:space-between; align-items:center; padding:.75rem 1rem; border-bottom:1px solid #eee; }
  .citation-dismiss { background:none; border:0; font-size:1.25rem; line-height:1; cursor:pointer; }
  .citation-close { background:#f8f9fa; border:1px solid #ddd; border-radius:4px; padding:.35rem .75rem; cursor:pointer; }
  .citation-close:hover { background:#e9ecef; }
  .citation-tabs { display:flex; gap:.25rem; padding:.5rem 1rem; border-bottom:1px solid #eee; }
  .tab-btn {
    border: 1px solid #ddd; background:#f8f9fa; border-radius:4px; padding:.35rem .6rem; cursor:pointer;
  }
  .tab-btn.is-active { background:#fff; border-color:#bbb; }
  .citation-body { padding:1rem; max-height:50vh; overflow:auto; }
  #citationContent { font-size:1rem; line-height:1.4; }
  .codebox {
    background:#f6f8fa; border:1px solid #e1e4e8; border-radius:6px;
    padding:.75rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size:.9rem; line-height:1.4; white-space:pre-wrap; word-break:break-word;
  }
  .tab-panel { display:none; }
  .tab-panel.is-active { display:block; }
  .citation-actions { display:flex; gap:.5rem; justify-content:flex-end; padding:.75rem 1rem; border-top:1px solid #eee; }
</style>

<script src="{{ "js/vendor/dompurify/purify.min.js" | relURL }}" defer></script>
<script src="{{ "js/vendor/prettier/standalone.js" | relURL }}" defer></script>
<script src="{{ "js/vendor/prettier/plugins/html.js" | relURL }}" defer></script>

<script>
(function () {
  const modal = document.getElementById('citationModal');
  if (!modal) return;
  const dialog = modal.querySelector('.citation-dialog');
  const contentBox = document.getElementById('citationContent');
  const rawBox = document.getElementById('citationRaw');
  const jsonBox = document.getElementById('citationJson');

  let lastActiveElement = null;

  // Make background content inert while modal is open.
  // Skip elements that contain the modal so modal buttons remain interactive.
  function setPageInert(inert) {
    const selectors = ['header', 'footer', 'nav', '.td-sidebar'];
    selectors.forEach(sel => {
      document.querySelectorAll(sel).forEach(el => {
        if (el && !el.contains(modal)) {
          if (inert) el.setAttribute('inert', '');
          else el.removeAttribute('inert');
        }
      });
    });
    // Make article content inert but not the modal
    const article = document.querySelector('article.bibliography-entry');
    if (article) {
      if (inert) article.setAttribute('inert', '');
      else article.removeAttribute('inert');
    }
  }

  function getFocusableElements() {
    const selector = [
      'a[href]',
      'button:not([disabled])',
      'textarea:not([disabled])',
      'input:not([disabled])',
      'select:not([disabled])',
      '[tabindex]:not([tabindex="-1"])'
    ].join(',');
    return Array.from(modal.querySelectorAll(selector)).filter(el => {
      const style = window.getComputedStyle(el);
      return style.visibility !== 'hidden' && style.display !== 'none';
    });
  }

  function openModal(triggerEl) {
    lastActiveElement = triggerEl || document.activeElement;
    modal.hidden = false;
    setPageInert(true);
    // Focus the first close control for predictable keyboard UX.
    const preferred = modal.querySelector('.citation-dismiss') || modal.querySelector('.citation-close');
    if (preferred && typeof preferred.focus === 'function') preferred.focus();
    else if (dialog && typeof dialog.focus === 'function') dialog.focus();
  }

  function closeModal() {
    modal.hidden = true;
    setPageInert(false);
    if (lastActiveElement && typeof lastActiveElement.focus === 'function') {
      try {
        lastActiveElement.focus();
      } catch (e) {
        // Element may have been removed from DOM; ignore.
      }
    }
    lastActiveElement = null;
  }

  function setActiveTab(name) {
    modal.querySelectorAll('.tab-btn').forEach(btn => {
      const isActive = btn.dataset.tab === name;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
    modal.querySelectorAll('.tab-panel').forEach(panel => {
      const isActive = panel.id === ('tab-' + name);
      panel.classList.toggle('is-active', isActive);
    });
  }

  function copyTextToClipboard(text, button) {
    const done = () => {
      if (button) {
        const original = button.textContent;
        button.textContent = 'Copied';
        setTimeout(() => (button.textContent = original), 1200);
      }
    };
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(done).catch(done);
    } else {
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta);
      ta.select(); try { document.execCommand('copy'); } catch(e) {}
      document.body.removeChild(ta); done();
    }
  }

  document.addEventListener('click', function (e) {
    // Open + fetch
    if (e.target.matches('#citeBtn')) {
      e.preventDefault();
      const btn = e.target;
      const gid = btn.dataset.gid;
      const key = btn.dataset.key;
      const style = btn.dataset.style || 'apa';
      // Use Zotero API; format=bib returns HTML bibliography item(s)
      const url = `https://api.zotero.org/groups/${encodeURIComponent(gid)}/items/${encodeURIComponent(key)}?format=bib&style=${encodeURIComponent(style)}&linkwrap=1`;

      contentBox.textContent = 'Loading…';
      rawBox.textContent = '';
      jsonBox.textContent = '';
      // store identifiers for later JSON fetch
      modal.dataset.gid = gid;
      modal.dataset.key = key;
      setActiveTab('formatted');
      openModal(btn);

      fetch(url, { headers: { 'Accept': 'text/html' }})
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.text();
        })
        .then(html => {
          // Sanitize HTML to prevent XSS before rendering
          const cleanHtml = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html;
          contentBox.innerHTML = cleanHtml;
          if (window.prettier && window.prettierPlugins) {
            try {
              const formatted = window.prettier.format(html, { parser: "html", plugins: window.prettierPlugins, tabWidth: 2, bracketSameLine: true, singleAttributePerLine: false, printWidth: 80, htmlWhitespaceSensitivity: "ignore" });
              // prettier.format may return a string or a Promise depending on plugin loading; normalize to a Promise
              return Promise.resolve(formatted).then(pretty => {
                rawBox.textContent = pretty;
                return html;
              });
            } catch (err) {
              // synchronous error formatting
              rawBox.textContent = String(err);
              return html;
            }
          }
          rawBox.textContent = html;
          return html;
        })
        .catch(err => {
          const msg = `Failed to load citation (${err})`;
          contentBox.textContent = msg;
          rawBox.textContent = msg;
        });
    }

    // Close
    if (e.target.matches('.citation-close, .citation-dismiss')) {
      e.preventDefault();
      closeModal();
    }

    // Copy button: copy content for the currently active tab (formatted/raw/json)
    if (e.target.matches('#copyCitation')) {
      e.preventDefault();
      const activeBtn = modal.querySelector('.tab-btn.is-active');
      const tab = activeBtn ? activeBtn.dataset.tab : 'formatted';
      let text = '';
      if (tab === 'formatted') text = contentBox.textContent.trim();
      else if (tab === 'raw') text = rawBox.textContent.trim();
      else if (tab === 'json') text = jsonBox.textContent.trim();
      // Don't copy loading or error states
      if (!text || /^(Loading|Failed|No Zotero)/i.test(text)) return;
      copyTextToClipboard(text, e.target);
    }

    // Tabs
    if (e.target.matches('.tab-btn')) {
      if (!modal.contains(e.target)) return;
      e.preventDefault();
      const tab = e.target.dataset.tab;
      setActiveTab(tab);
      // If JSON tab selected, lazily fetch CSL JSON from Zotero API
      if (tab === 'json' && jsonBox.textContent.trim() === '') {
        const gid = modal.dataset.gid;
        const key = modal.dataset.key;
        if (gid && key) {
          const url = `https://api.zotero.org/groups/${encodeURIComponent(gid)}/items/${encodeURIComponent(key)}?format=csljson`;
          jsonBox.textContent = 'Loading…';
          fetch(url, { headers: { 'Accept': 'application/json' }})
            .then(r => {
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              return r.json();
            })
            .then(obj => {
              try {
                jsonBox.textContent = JSON.stringify(obj, null, 2);
              } catch (err) {
                jsonBox.textContent = String(err);
              }
            })
            .catch(err => {
              jsonBox.textContent = `Failed to load JSON (${err})`;
            });
        } else {
          jsonBox.textContent = 'No Zotero identifiers available.';
        }
      }
    }
  });

  // Close when clicking backdrop or pressing Escape
  modal.addEventListener('click', function (e) {
    if (e.target.classList.contains('citation-backdrop')) closeModal();
  });
  document.addEventListener('keydown', function (e) {
    if (modal.hidden) return;
    if (e.key === 'Escape') {
      closeModal();
      return;
    }
    if (e.key === 'Tab') {
      const focusable = getFocusableElements();
      if (focusable.length === 0) {
        e.preventDefault();
        return;
      }
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      const active = document.activeElement;
      if (e.shiftKey) {
        if (active === first || !modal.contains(active)) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (active === last) {
          e.preventDefault();
          first.focus();
        }
      }
    }
  });
})();
</script>

{{ end }}
